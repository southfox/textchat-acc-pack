(function(){var e,t,n;"object"==typeof module&&"object"==typeof module.exports?(e=require("underscore"),t=require("jquery"),window.jQuery=t,window.moment=require("moment"),require("kuende-livestamp"),n=require("opentok-solutions-logging")):(e=this._,t=this.$,window.jQuery=t,window.moment=this.moment,n=this.OTKAnalytics);var s,i,a,o,c,r,d,l,u={clientVersion:"js-vsol-2.0.0",componentId:"textChatAccPack",name:"guidTextChatAccPack",actionInitialize:"Init",actionStart:"Start",actionEnd:"End",actionOpen:"OpenTC",actionClose:"CloseTC",actionSendMessage:"SendMessage",actionReceiveMessage:"ReceiveMessage",actionSetMaxLength:"SetMaxLength",variationAttempt:"Attempt",variationError:"Failure",variationSuccess:"Success"},m=function(){var e=window.location.href,t={clientVersion:u.clientVersion,source:e,componentId:u.componentId,name:u.name};a=new n(t);var s={sessionId:i.id,connectionId:i.connection.connectionId,partnerId:i.apiKey};a.addSessionInfo(s)},v=function(e,t){var n={action:e,variation:t};a.logEvent(n)},g=!1,p=!1,h=!1,f=!1,C=[],y=!1,x=function(e,t){l&&l.triggerEvent(e,t)},S=function(){var e=s.options.waitingMessage||"Messages will be delivered once your contact arrives";return['<div class="ots-text-chat-container">','<div class="ots-text-chat">','<div class="ots-messages-header ots-hidden" id="chatHeader">',"<span>Chat with</span>","</div>",'<div id="otsChatWrap">','<div class="ots-messages-holder" id="messagesHolder">','<div class="ots-messages-alert ots-hidden" id="messagesWaiting">'+e+"</div>",'<div class="ots-message-item ots-message-sent">',"</div>","</div>",'<div class="ots-send-message-box">','<input type="text" maxlength='+s.options.limitCharacterMessage+' class="ots-message-input" placeholder="Enter your message here" id="messageBox">','<button class="ots-icon-check" id="sendMessage" type="submit"></button>','<div class="ots-character-count"><span><span id="characterCount">0</span>/'+s.options.limitCharacterMessage+" characters</span></div>","</div>","</div>","</div>","</div>"].join("\n")},w=function(e){return!!r&&(r.sender.id===e.sender.id&&r.sender.id===e.sender.id)},M=function(){c.value="",t("#characterCount").text("0")},E=function(e){var t=['<div class="'+e.messageClass+'" >','<div class="ots-user-name-initial"> '+e.username[0]+"</div>",'<div class="ots-item-timestamp"> '+e.username+', <span data-livestamp=" '+new Date(e.time)+'" </span></div>','<div class="ots-item-text">',"<span> "+e.message+"</span>","</div>","</div>"].join("\n");return t},I=function(e,n,s,i){var a=o.id===e?"ots-message-item ots-message-sent":"ots-message-item",c=E({username:n,message:s,messageClass:a,time:i}),r=t(d);r.append(c),M(),r[0].scrollTop=r[0].scrollHeight},T=function(e){if(w(e)){t(".ots-item-text").last().append(["<span>",e.message,"</span>"].join(""));var n=t(d);n[0].scrollTop=n[0].scrollHeight,M()}else I(o.id,o.alias,e.message,e.sentOn);r=e,x("messageSent",e)},k=function(n){if(console.log(n.code,n.message),500===n.code){var i=e.template(t("#chatError").html());t(s.comms_elements.messagesView).append(i())}x("errorSendingMessage",n)},O=function(){var e=document.getElementById("messagesWaiting");e&&e.classList.remove("ots-hidden")},b=function(){var e=document.getElementById("messagesWaiting");e&&e.classList.add("ots-hidden")},L=function(n,s){var a=new t.Deferred;C.push({recipient:n,message:s}),y?b():(O(),a.resolve());var c={text:s,sender:{id:o.id,alias:o.alias},sentOn:Date.now()};return v(u.actionSendMessage,u.variationAttempt),void 0===n?i.signal({type:"text-chat",data:JSON.stringify(c)},function(t){if(t){var n="Error sending a message. ";v(u.actionSendMessage,u.variationFailure),413===t.code?n+="The chat message is over size limit.":500===t.code&&(n+="Check your network connection."),a.reject(e.extend(e.omit(t,"message")),{message:n})}else console.log("Message sent"),v(u.actionSendMessage,u.variationSuccess),a.resolve(c)}):i.signal({type:"text-chat",data:JSON.stringify(c),to:n},function(e){e?(console.log("Error sending a message"),v(u.actionSendMessage,u.variationFailure),a.resolve(e)):(console.log("Message sent"),a.resolve(c),v(u.actionSendMessage,u.variationSuccess))}),a.promise()},j=function(n){e.isEmpty(n)||t.when(L(s._remoteParticipant,n)).then(function(){T({sender:{id:o.id,alias:o.alias},message:n,sentOn:Date.now()}),this.futureMessageNotice&&(this.futureMessageNotice=!1)},function(e){k(e)})},q=function(){v(u.actionInitialize,u.variationAttempt);var e=document.querySelector(s.options.textChatContainer)||document.body,n=document.createElement("section");n.innerHTML=S(),c=n.querySelector("#messageBox"),d=n.querySelector("#messagesHolder"),c.onkeyup=function(){t("#characterCount").text(c.value.length),0!=c.value.length?t(".ots-icon-check").addClass("active"):t(".ots-icon-check").removeClass("active")},c.onkeydown=function(e){var t=13===e.which||13===e.keyCode;!e.shiftKey&&t&&(e.preventDefault(),j(c.value))},e.appendChild(n),document.getElementById("sendMessage").onclick=function(){j(c.value)},v(u.actionInitialize,u.variationSuccess)},A=function(e){v(u.actionReceiveMessage,u.variationAttempt);var n=JSON.parse(e.data);w(n)?t(".ots-item-text").last().append(["<span>",n.text,"</span>"].join("")):I(n.sender.id,n.sender.alias,n.text,n.sentOn),r=n,v(u.actionReceiveMessage,u.variationSuccess)},D=function(e){var t=i.connection.connectionId,n=e.from.connectionId;if(n!==t){var s=A(e);s&&"function"==typeof s&&s(e),x("messageReceived",e)}},H=function(){C.forEach(function(e){L(e.recipient,e.message)}),C=[]},P=function(e){e.from.connectionId!==i.connection.connectionId&&(y=!0,H())},B=function(){var e={type:"text-chat-ready",data:JSON.stringify({ready:!0})};i.on("signal:text-chat-ready",P),i.signal(e,function(e){e&&console.log("Error sending ready signal",e)})},N=function(){v(u.actionStart,u.variationAttempt),g=!0,p=!0,h=!0,q(),x("showTextChat"),i.on("signal:text-chat",D),B(),v(u.actionStart,u.variationSuccess)},R=function(){v(u.actionOpen,u.variationAttempt),document.querySelector(s.options.textChatContainer).classList.remove("ots-hidden"),p=!0,x("showTextChat"),v(u.actionOpen,u.variationSuccess)},_=function(){v(u.actionClose,u.variationAttempt),v(u.actionEnd,u.variationAttempt),document.querySelector(s.options.textChatContainer).classList.add("ots-hidden"),p=!1,x("hideTextChat"),v(u.actionClose,u.variationSuccess),v(u.actionEnd,u.variationSuccess)},z=function(){var e=document.querySelector(s.options.controlsContainer),t=document.createElement("div");t.innerHTML='<div class="ots-video-control circle text-chat enabled" id="enableTextChat"></div>';var n=t.firstChild;e.appendChild(n),f=!0,n.onclick=function(){h?p?_():R():N()}},J=function(t){if(!t.session)throw new Error("Text Chat Accelerator Pack requires an OpenTok session.");var n=function(e){var t=e||3;return Math.random().toString(36).substr(2,t)},s=function(){return[n(),i.id,n()].join("")};return i=e.property("session")(t),l=e.property("accPack")(t),o=e.defaults(t.sender||{},{id:s(),alias:["User",n()].join(" ")}),e.defaults(e.omit(t,["accPack","_sender"]),{limitCharacterMessage:160,controlsContainer:"#feedControls",textChatContainer:"#chatContainer",alwaysOpen:!1})},V=function(){var e=["showTextChat","hideTextChat","messageSent","errorSendingMessage","messageReceived"];l&&l.registerEvents(e)},W=function(e){e&&e.connection.connectionId!==i.connection.connectionId&&(y=!0,b())},F=function(e){e&&e.stream.connection.connectionId!==i.connection.connectionId&&(y=!0,b())},K=function(){i.streams.length()<2&&(y=!1)},Q=function(){l?(l.registerEventListener("streamCreated",F),l.registerEventListener("streamDestroyed",K),l.registerEventListener("startCall",function(){s.options.alwaysOpen||(f?document.querySelector("#enableTextChat").classList.remove("ots-hidden"):z())}),l.registerEventListener("endCall",function(){s.options.alwaysOpen||(document.getElementById("enableTextChat").classList.add("ots-hidden"),p&&_())})):(i.on("streamCreated",F),i.on("streamDestroyed",K)),i.on("connectionCreated",W),F()},U=function(t){s=this,s.options=J(t),m(),e.property("_this.options.limitCharacterMessage")(t)&&v(u.actionSetMaxLength,u.variationSuccess),s.options.alwaysOpen?N():z(),V(),Q()};U.prototype={constructor:U,isEnabled:function(){return g},isDisplayed:function(){return p},showTextChat:function(){R()},hideTextChat:function(){_()}},"object"==typeof exports?module.exports=U:"function"==typeof define&&define.amd?define(function(){return U}):this.TextChatAccPack=U}).call(this);